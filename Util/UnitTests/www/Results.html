<html>

  <head>
    <meta charset="UTF-8">
    <script src="jquery-2.1.4.min.js"></script>
    <script src="Chart.js-2.0-dev/Chart.js"></script>
    
    <link rel='stylesheet' type='style/css' href='Results.css'>
    
    <script>
    function LoadModel() {
      var res = [{
        name:'Some Category',
        children: [{
          name:'Some Test',
          testcases: [
            {
              name:'bouncing_ball_10',
              time: '2015-11-27',
              fps_min:59,
              fps_avg:60,
              fps_max:60,
              history:[
                {time: '2015-11-16', fps_min:10, fps_max:50, fps_avg:15},
                {time: '2015-11-17', fps_min:11, fps_max:30, fps_avg:20},
                {time: '2015-11-18', fps_min:15, fps_max:30, fps_avg:20},
                {time: '2015-11-19', fps_min:8,  fps_max:30, fps_avg:20},
                {time: '2015-11-20', fps_min:25, fps_max:30, fps_avg:20},
                {time: '2015-11-21', fps_min:26, fps_max:30, fps_avg:20},
                {time: '2015-11-22', fps_min:25, fps_max:30, fps_avg:20},
                {time: '2015-11-23', fps_min:20, fps_max:30, fps_avg:20},
                {time: '2015-11-24', fps_min:27, fps_max:30, fps_avg:20},
                {time: '2015-11-25', fps_min:29, fps_max:30, fps_avg:20},
                {time: '2015-11-26', fps_min:30, fps_max:30, fps_avg:20}
              ]
            },
            {
              name:'bouncing_ball_100',
              time: '2015-11-27',
              fps_min:20,
              fps_avg:25,
              fps_max:30,
              history:[{time: '2015-11-25', fps_min:30, fps_max:50, fps_avg:40}, {time: '2015-11-26', fps_min:10, fps_max:30, fps_avg:20}]    
            },
            {
              name:'bouncing_ball_100',
              time: '2015-11-27',
              fps_min:20,
              fps_avg:25,
              fps_max:30,
              history:[{time: '2015-11-25', fps_min:30, fps_max:50, fps_avg:40}, {time: '2015-11-26', fps_min:10, fps_max:30, fps_avg:20}]     
            },
            {
              name:'bouncing_ball_100',
              time: '2015-11-27',
              fps_min:20,
              fps_avg:25,
              fps_max:30,
              history:[{time: '2015-11-25', fps_min:30, fps_max:50, fps_avg:40}, {time: '2015-11-26', fps_min:10, fps_max:30, fps_avg:20}]
            }            
          ]}]
        }];
      return res;
    }
       
    var all_graphs = [];
    
    function ConstructTestCases(model, target) {
      var container = $('<div>');
      container.addClass('Test_Container');
      for(var i = 0; i < model.length; i++) {
        var div = $('<div>');
        div.addClass('TestCase');
        var name_div = $('<div>');
        name_div.addClass('TestCase_name');
        name_div.append(model[i].name);
        div.append(name_div);
        
        var graph_div = $('<div>');
        graph_div.addClass('TestCase_graph');        
        
        var graph_canvas = $('<canvas>');
        graph_div.append(graph_canvas);
        
        var max_color = "rgba(220,0, 0,";
        var avg_color = "rgba(0, 0, 220,";
        var min_color = "rgba(160, 160, 0,";     
             
        var graph_config = 
          {
            type : 'line',
            data: {
              labels: [],
              datasets:[
                  {
                    label: 'fps_max', 
                    fill: false,
                    backgroundColor: max_color+"0.2)",
                    borderColor: max_color+"1)",
                    pointBorderColor: max_color+"1)",
                    pointBackgroundColor: "#fff",
                    pointBorderWidth: 1,
                    pointHoverRadius: 5,
                    pointHoverBackgroundColor: max_color+"1)",
                    pointHoverBorderColor: max_color+"1)",
                    pointHoverBorderWidth: 2,   
                    data: []},
                  {
                    label: 'fps_avg',
                    fill: false,
                    backgroundColor: avg_color+"0.2)",
                    borderColor: avg_color+"1)",
                    pointBorderColor: avg_color+"1)",
                    pointBackgroundColor: "#fff",
                    pointBorderWidth: 1,
                    pointHoverRadius: 5,
                    pointHoverBackgroundColor: avg_color+"1)",
                    pointHoverBorderColor: avg_color+"1)",
                    pointHoverBorderWidth: 2,   
                    data: []},
                  {            
                    label: 'fps_min',
                    fill: false,
                    backgroundColor: min_color+"0.2)",
                    borderColor: min_color+"1)",
                    pointBorderColor: min_color+"1)",
                    pointBackgroundColor: "#fff",
                    pointBorderWidth: 1,
                    pointHoverRadius: 5,
                    pointHoverBackgroundColor: min_color+"1)",
                    pointHoverBorderColor: min_color+"1)",
                    pointHoverBorderWidth: 2,   
                    data: []}                      
                ]
              },
            options:{
							maintainAspectRatio: true,
							responsive: true,
							scaleShowLabels: true,
							legendCallback : function(controller){
							var data = controller.data;
                var res = "<p>Legend:</br>";
                for (var k=0; k<data.datasets.length; k++){
                  res += "<span style=\"color:" +data.datasets[k].pointBorderColor+"\">";
                  if(data.datasets[k].label){
                    res += data.datasets[k].label;
                  }
                  res += "</span></br>";                  
                }
                res += "</p>";							
                return res;
							},
                scales: {
                    xAxes: [{
                        display: true,
                        ticks : {
                          beginAtZero: true,
                          suggestedMin: 0,
                          suggestedMax: 60
                        }
                        
                    }],
                    yAxes: [{
                        display: true,
                        scaleLabel: {
                            show: true,
                            labelString: 'Framerate'
                        },
                        ticks : {
                          beginAtZero: true,
                          suggestedMin: 0,
                          suggestedMax: 60
                        }
                    }]
                }			
						}
          }       
        
        // Chart.js will fail if the canvas isn't visible in the document when Chart() is called. For that reason we append it to the body, call Chart() and then detach it so we can put it in graph_div afterwards.
        $('body').append(graph_div);
        model[i].chart = new Chart(graph_canvas.get(0), graph_config);        

        for(j = 0; j < model[i].history.length; j++) {
          graph_config.data.labels.push(model[i].history[j].time);
          graph_config.data.datasets[0].data.push(model[i].history[j].fps_max);
          graph_config.data.datasets[1].data.push(model[i].history[j].fps_avg);
          graph_config.data.datasets[2].data.push(model[i].history[j].fps_min);          
        }
        
        graph_config.data.labels.push(model[i].time);
        graph_config.data.datasets[0].data.push(model[i].fps_max);
        graph_config.data.datasets[1].data.push(model[i].fps_avg);
        graph_config.data.datasets[2].data.push(model[i].fps_min);
        
        var c = model[i].chart.chart.ctx;
        model[i].chart.destroy();
        model[i].chart = new Chart(c, graph_config);
        
        graph_div.detach();
        all_graphs.push(model[i].chart);
        div.append(graph_div);       
        var data_div = $('<div>');
        data_div.addClass('TestCase_data');
        var data_list = $('<ul>');
        data_list.addClass('TestCase_data_list');
        data_list.append('Latest:');
        data_list.append('<li>Min FPS:'+model[i].fps_min+'</li>');
        data_list.append('<li>Avg FPS:'+model[i].fps_avg+'</li>');
        data_list.append('<li>Max FPS:'+model[i].fps_max+'</li>');
        data_list.append(model[i].chart.generateLegend());
        data_div.append(data_list);
        div.append(data_div);
        container.append(div);
      }
      target.append(container);
    }
    
    var CategoryCount = 0;
    
      var first = true;
    function ConstructList(model, target) {
      model.push(model[0]);
      for (var i = 0; i < model.length; i++) {
        var ul = $('<ul>');
        ul.attr('class', 'Category_Item');
        
        var label = $('<label>');
        label.attr('class', 'noselect');       
        var glyph = $('<div>');
        glyph.attr('class', 'glyph');
        glyph.html('â–º');
        
        label.append(glyph);
        label.append('<h3>'+model[i].name+'</h3>');
        label.attr('for', 'category'+CategoryCount);
        
        var input = $('<input>');
        input.attr('type', 'checkbox');
        input.attr('id', 'category'+CategoryCount);
        if(first)
          input.prop('checked', true);
        ul.append(input);
        ul.append(label);
        
        CategoryCount++;
        
        if(model[i].hasOwnProperty('children'))
          ConstructList(model[i].children, ul);
        else if (model[i].hasOwnProperty('testcases')) {
          ConstructTestCases(model[i].testcases, ul);
          first = false;
        }
               
        target.append(ul);
      }      
    }

    var model = LoadModel();
    
    function updateVisibleCharts() {
      //$('.TestCase:visible').each
    }
    
    $(document).ready(function(){
      ConstructList(model, $('#Categories'));
    });    

              
    </script>
        
  </head>

  <body>
    <div id='Header'><h1>Test Results</h1></div>
    <div id='Content'>
      <div id='Categories' class='Category_Item'><h2>Categories</h2>

      </div>
    </div>
  </body>

</html>